<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title></title>
  <script src="pcodes.js"></script>
  <script>
    LER = {
      inited: false,
      lawNames: [],
      lawNameRE: null,
      artNumRE: null,
      lastPCode: "",

      /// Regular Expression Text
      retNumber: "[\\d零一二三四五六七八九十百千]+",
      retElement: "第(%number%)條(之(%number%))?",
      retElements: "not supported",

      init: function(){
        for(var i = 0; i < pcodes.length; ++i) {
          var name = pcodes[i].name;
          if(name.length > 64) continue; /// 超過得也不會通過下一關，不過這邊或許可以省些時間？
          if(/[\w\s\(\)（）「」，、：　]/.test(name)) continue;
          this.lawNames.push(name);
        }
        this.lawNames.sort(function(a,b){return b.length-a.length});

        this.lawNameRE = new RegExp(LER.lawNames.join("|"), 'g');
        this.artNumRE = new RegExp(this.retElement.replace(new RegExp("%number%", 'g'), this.retNumber), 'g');

        this.inited = true;
      },

      getPCodeByName: function(name) {
        for(var i = 0; i < pcodes.length; ++i) {
          if(name == pcodes[i].name) return pcodes[i].PCode;
        }
        return null;
      },

      parse: function(str) {
        var result = [];
        this.lawNameRE.lastIndex = 0;
        var splitted = str.split(this.lawNameRE);
        var matched = str.match(this.lawNameRE);
        // alert(splitted.length); alert(matched.length);
        for(var i = 0; i < splitted.length; ++i) {
          if(splitted[i].replace(/\s+/, '').length > 0) {
            if(this.lastPCode.length)
              result = result.concat(this.parseArtNum(splitted[i]));
            else result.push(document.createTextNode(splitted[i]));
          }
          /// handle matched law names
          if(i == matched.length) break;
          this.lastPCode = this.getPCodeByName(matched[i]);
          var node = document.createElement('A');
          node.appendChild(document.createTextNode(matched[i]));
          node.setAttribute('href', "http://law.moj.gov.tw/LawClass/LawAll.aspx?PCode=" + this.lastPCode);
          node.setAttribute('target', '_blank');
          result.push(node);
        }
        return result;
      },

      parseArtNum: function(str) {
        var result = [];
        this.artNumRE.lastIndex = 0;
        var splitted = str.split(this.artNumRE);
        var matched = str.match(this.artNumRE);

        result.push(document.createTextNode(str));
        /*alert(splitted.length + str); alert(matched.length);
        for(var i = 0; i < splitted.length; ++i) {
          if(splitted[i].replace(/\s+/, '').length > 0)
            result.push(document.createTextNode(splitted[i]));
          if(i == matched.length) break;

          var href = "http://law.moj.gov.tw/LawClass/LawSingle.aspx?Pcode=" + this.lastPCode + "&FLNO=" + 1;
          var node = document.createElement('A');
          node.appendChild(document.createTextNode(matched[i]));
          node.setAttribute('href', href);
          node.setAttribute('target', '_blank');
          result.push(node);
        } */
        return result;
      },

      dummy: null
    };
    LER.init();
  </script>

  </head>
  <body style="padding-top: 60px;">
    <div style="position:absolute; top: 0; left: 0; width: 100%; padding: 0.25em; text-align: center; color: #fff; background-color: #000; font-weight: bold; font-size: 32px;">Sorry, 我沒有筆電所以只好來霸占這台。</div>
    <script>
      str = "儘管公民投票法雖然在第三十條說了XXXX，但是第三十一條之二卻又YYYY；社會秩序維護法第八十條第一款則ZZZZ。";
      document.write(str);


    </script>
  </body>
</html>
